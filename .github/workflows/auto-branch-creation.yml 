name: è‡ªå‹•ãƒ–ãƒ©ãƒ³ãƒä½œæˆ - TaskFlow
on:
  issues:
    types: [labeled]

jobs:
  create-branch:
    # 'ready-for-dev' ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸæ™‚ã ã‘å®Ÿè¡Œ
    if: contains(github.event.issue.labels.*.name, 'ready-for-dev')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é–‹ç™ºç”¨ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        run: |
          # Issueç•ªå·ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’ä½œæˆï¼ˆè‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ï¼‰
          BRANCH_SUFFIX=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g' | cut -c1-30)
          BRANCH_NAME="feature/issue-${ISSUE_NUMBER}-${BRANCH_SUFFIX}"
          
          echo "ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆä¸­: $BRANCH_NAME"
          
          # mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout main
          git pull origin main
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          # å¾Œã§ä½¿ã†ãŸã‚ã«ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = process.env.BRANCH_NAME;
            const comment = `ğŸŒŸ **é–‹ç™ºç”¨ãƒ–ãƒ©ãƒ³ãƒã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸï¼**
            
            ãƒ–ãƒ©ãƒ³ãƒå: \`${branchName}\`
            
            **Claude Code ã§ä½œæ¥­ã™ã‚‹æ‰‹é †:**
            \`\`\`bash
            # 1. æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
            git fetch origin
            
            # 2. ä½œæˆã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
            git checkout ${branchName}
            
            # 3. ãƒ–ãƒ©ãƒ³ãƒã‚’æœ€æ–°ã«ã™ã‚‹
            git pull origin ${branchName}
            
            # 4. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            npm install
            
            # 5. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
            npm run dev
            \`\`\`
            
            **é–‹ç™ºã®æµã‚Œ:**
            1. \`.claude-instructions.md\` ã‚’èª­ã‚“ã§é–‹ç™ºãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
            2. ã“ã®issueã®å†…å®¹ã ã‘ã‚’å®Ÿè£…
            3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000 ã§å‹•ä½œç¢ºèª
            4. å®Œæˆã—ãŸã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ï¼‰
            
            **TaskFlow æŠ€è¡“æƒ…å ±:**
            - ã‚µãƒ¼ãƒãƒ¼: Node.js + Express
            - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: EJS
            - ã‚¹ã‚¿ã‚¤ãƒ«: Bootstrap 5
            - é–‹ç™ºä¸­æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            
            **é‡è¦:** ä»–ã®ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã¯å–ã‚Šè¾¼ã¾ãªã„ã§ãã ã•ã„ï¼
            å›°ã£ãŸæ™‚ã¯ \`.claude-instructions.md\` ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });